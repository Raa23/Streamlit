import streamlit as st
import io
from typing import Dict, List
import time

# ============================================================================
# PLACEHOLDER FUNCTIONS - Replace with your actual implementations
# ============================================================================

def question_to_bullets(question: str) -> Dict[str, List[str]]:
    """
        Takes a general question and returns a dict with:
            - keys: main question parts
                - values: list of enriched sub-questions
                    
                        Replace this with your actual LangChain implementation
                            """
                                # Placeholder implementation
                                    time.sleep(1)  # Simulate processing
                                        return {
                                                "Part 1: Main Topic": [
                                                            "Enriched question 1.1 about the topic",
                                                                        "Enriched question 1.2 with more context",
                                                                                    "Enriched question 1.3 diving deeper"
                                                                                            ],
                                                                                                    "Part 2: Secondary Aspect": [
                                                                                                                "Enriched question 2.1 exploring aspect",
                                                                                                                            "Enriched question 2.2 with specifics"
                                                                                                                                    ]
                                                                                                                                        }

                                                                                                                                        def read_document(file_bytes: io.BytesIO) -> str:
                                                                                                                                            """
                                                                                                                                                Takes file bytes and returns extracted text
                                                                                                                                                    Replace with your actual document reader
                                                                                                                                                        """
                                                                                                                                                            # Placeholder implementation
                                                                                                                                                                time.sleep(0.5)  # Simulate processing
                                                                                                                                                                    return f"Extracted text from document (placeholder)\n" * 10

                                                                                                                                                                    def chunk_and_embed(text: str):
                                                                                                                                                                        """
                                                                                                                                                                            Splits text into chunks and creates embeddings
                                                                                                                                                                                Replace with your actual embedding implementation
                                                                                                                                                                                    """
                                                                                                                                                                                        # Placeholder - return a mock vector store or embedding object
                                                                                                                                                                                            time.sleep(1)  # Simulate processing
                                                                                                                                                                                                return {"status": "embedded", "chunks": 15}

                                                                                                                                                                                                def answer_with_llm(enriched_question: str, vector_store) -> str:
                                                                                                                                                                                                    """
                                                                                                                                                                                                        Uses LLM to answer the enriched question with similar paragraphs
                                                                                                                                                                                                            Replace with your actual LangChain LLM implementation
                                                                                                                                                                                                                """
                                                                                                                                                                                                                    # Placeholder implementation
                                                                                                                                                                                                                        time.sleep(0.8)  # Simulate LLM call
                                                                                                                                                                                                                            return f"Answer to: {enriched_question}\n\nThis is a placeholder answer that would contain the LLM's response based on the retrieved context from the documents."

                                                                                                                                                                                                                            def summarize_answers(question_part: str, answers: List[str]) -> str:
                                                                                                                                                                                                                                """
                                                                                                                                                                                                                                    Summarizes multiple enriched answers into one main answer
                                                                                                                                                                                                                                        Replace with your actual summarization logic
                                                                                                                                                                                                                                            """
                                                                                                                                                                                                                                                # Placeholder implementation
                                                                                                                                                                                                                                                    time.sleep(0.5)  # Simulate processing
                                                                                                                                                                                                                                                        return f"Summary for '{question_part}':\n\nThis is a synthesized answer combining all the enriched sub-question responses. [Placeholder]"

                                                                                                                                                                                                                                                        # ============================================================================
                                                                                                                                                                                                                                                        # STREAMLIT APP
                                                                                                                                                                                                                                                        # ============================================================================

                                                                                                                                                                                                                                                        st.set_page_config(
                                                                                                                                                                                                                                                            page_title="Document Analysis with LLM",
                                                                                                                                                                                                                                                                page_icon="üìÑ",
                                                                                                                                                                                                                                                                    layout="wide",
                                                                                                                                                                                                                                                                        initial_sidebar_state="expanded"
                                                                                                                                                                                                                                                                        )

                                                                                                                                                                                                                                                                        # Custom CSS for modern look
                                                                                                                                                                                                                                                                        st.markdown("""
                                                                                                                                                                                                                                                                            <style>
                                                                                                                                                                                                                                                                                .main {
                                                                                                                                                                                                                                                                                        padding: 2rem;
                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                .stButton>button {
                                                                                                                                                                                                                                                                                                        width: 100%;
                                                                                                                                                                                                                                                                                                                background-color: #4CAF50;
                                                                                                                                                                                                                                                                                                                        color: white;
                                                                                                                                                                                                                                                                                                                                font-weight: 600;
                                                                                                                                                                                                                                                                                                                                        padding: 0.5rem;
                                                                                                                                                                                                                                                                                                                                                border-radius: 8px;
                                                                                                                                                                                                                                                                                                                                                        border: none;
                                                                                                                                                                                                                                                                                                                                                                transition: all 0.3s;
                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                        .stButton>button:hover {
                                                                                                                                                                                                                                                                                                                                                                                background-color: #45a049;
                                                                                                                                                                                                                                                                                                                                                                                        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                .upload-section {
                                                                                                                                                                                                                                                                                                                                                                                                        border: 2px dashed #4CAF50;
                                                                                                                                                                                                                                                                                                                                                                                                                border-radius: 10px;
                                                                                                                                                                                                                                                                                                                                                                                                                        padding: 2rem;
                                                                                                                                                                                                                                                                                                                                                                                                                                text-align: center;
                                                                                                                                                                                                                                                                                                                                                                                                                                        background-color: #f8f9fa;
                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                .step-badge {
                                                                                                                                                                                                                                                                                                                                                                                                                                                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                color: white;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        padding: 0.3rem 0.8rem;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                border-radius: 20px;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        font-size: 0.85rem;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                font-weight: 600;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        display: inline-block;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                margin-bottom: 0.5rem;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        .success-badge {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        color: white;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                padding: 0.3rem 0.8rem;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        border-radius: 20px;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                font-size: 0.85rem;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        font-weight: 600;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                display: inline-block;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </style>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        """, unsafe_allow_html=True)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Initialize session state
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if 'bullets' not in st.session_state:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.session_state.bullets = None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if 'enriched_questions' not in st.session_state:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                st.session_state.enriched_questions = None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if 'vector_store' not in st.session_state:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.session_state.vector_store = None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if 'final_results' not in st.session_state:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.session_state.final_results = None

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # ============================================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # SIDEBAR - Question Processing
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # ============================================================================

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        with st.sidebar:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.title("üîç Question Setup")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Step 1: Main Question
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.markdown("### Step 1: Main Question")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            default_question = "What are the key findings and recommendations in the uploaded documents?"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                main_question = st.text_area(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "Enter your question:",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                value=default_question,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        height=100,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                help="This question will be broken down into specific parts"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Button to generate bullets
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if st.button("üéØ Generate Sub-Questions", key="gen_bullets"):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        with st.spinner("Breaking down question..."):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.session_state.bullets = question_to_bullets(main_question)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                st.session_state.enriched_questions = st.session_state.bullets.copy()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.success("‚úÖ Sub-questions generated!")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Step 2: Edit Bullets
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if st.session_state.bullets:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.markdown("---")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.markdown("### Step 2: Review & Edit")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    edited_questions = {}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            for main_part, sub_questions in st.session_state.bullets.items():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.markdown(f"**{main_part}**")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    edited_subs = []
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                for i, sub_q in enumerate(sub_questions):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                edited_sub = st.text_input(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    f"Sub-question {i+1}",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        value=sub_q,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            key=f"sub_{main_part}_{i}",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                label_visibility="collapsed"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                edited_subs.append(edited_sub)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            edited_questions[main_part] = edited_subs
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.session_state.enriched_questions = edited_questions
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.markdown("---")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.info(f"üìä Total questions: {sum(len(v) for v in edited_questions.values())}")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # ============================================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # MAIN AREA - Document Upload and Processing
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # ============================================================================

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.title("üìÑ Document Analysis with LLM")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.markdown("Upload your documents and get AI-powered insights based on your custom questions.")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Document Upload Section
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.markdown("### üì§ Upload Documents")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    uploaded_files = st.file_uploader(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "Drop your documents here",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            accept_multiple_files=True,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                type=['pdf', 'docx', 'txt', 'csv', 'xlsx'],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    help="Supported formats: PDF, DOCX, TXT, CSV, XLSX"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    )

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if uploaded_files:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.success(f"‚úÖ {len(uploaded_files)} document(s) uploaded")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                with st.expander("üìã Uploaded Files", expanded=False):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for file in uploaded_files:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.write(f"- {file.name} ({file.size / 1024:.2f} KB)")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Process Button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.markdown("---")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    col1, col2, col3 = st.columns([1, 2, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    with col2:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        process_button = st.button(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "üöÄ Process Documents",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        disabled=not (uploaded_files and st.session_state.enriched_questions),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                help="Upload documents and generate questions first"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    )

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Processing Logic
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if process_button:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.session_state.final_results = {}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Step 1: Document Reading and Embedding
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.markdown("---")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.markdown('<div class="step-badge">STEP 1: Processing Documents</div>', unsafe_allow_html=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                progress_bar = st.progress(0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    status_text = st.empty()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            all_text = ""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                for idx, file in enumerate(uploaded_files):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        status_text.text(f"Reading: {file.name}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                file_bytes = io.BytesIO(file.read())
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        text = read_document(file_bytes)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                all_text += text + "\n\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        progress_bar.progress((idx + 1) / len(uploaded_files))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                status_text.text("Creating embeddings...")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.session_state.vector_store = chunk_and_embed(all_text)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        progress_bar.progress(1.0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                st.markdown('<div class="success-badge">‚úì Documents processed and embedded</div>', unsafe_allow_html=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Step 2: Answering Questions
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.markdown("---")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                st.markdown('<div class="step-badge">STEP 2: Answering Questions</div>', unsafe_allow_html=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        total_questions = sum(len(subs) for subs in st.session_state.enriched_questions.values())
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            question_progress = st.progress(0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                question_status = st.empty()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        current_q = 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                for main_part, sub_questions in st.session_state.enriched_questions.items():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.markdown(f"#### {main_part}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        intermediate_answers = []
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        with st.expander("View detailed answers", expanded=False):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for i, sub_q in enumerate(sub_questions):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    current_q += 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    question_status.text(f"Processing question {current_q}/{total_questions}: {sub_q[:50]}...")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    answer = answer_with_llm(sub_q, st.session_state.vector_store)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    intermediate_answers.append(answer)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.markdown(f"**Q{i+1}:** {sub_q}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.markdown(f"*Answer:* {answer}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.markdown("---")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    question_progress.progress(current_q / total_questions)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Summarize for this main part
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            question_status.text(f"Summarizing answers for: {main_part}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    summary = summarize_answers(main_part, intermediate_answers)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.session_state.final_results[main_part] = summary
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    question_status.text("Complete!")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.markdown('<div class="success-badge">‚úì All questions answered</div>', unsafe_allow_html=True)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Final Results
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if st.session_state.final_results:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.markdown("---")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                st.markdown("## üéØ Final Results")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for main_part, summary in st.session_state.final_results.items():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                with st.container():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.markdown(f"### {main_part}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.markdown(summary)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.markdown("---")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Download button for results
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                results_text = "\n\n".join([f"# {k}\n\n{v}" for k, v in st.session_state.final_results.items()])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.download_button(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            label="üì• Download Results",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    data=results_text,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            file_name="analysis_results.txt",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    mime="text/plain"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )